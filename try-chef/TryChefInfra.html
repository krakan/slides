<!DOCTYPE html>
<html class=" js flexbox flexboxlegacy canvas canvastext webgl no-touch geolocation postmessage no-websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients no-cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers applicationcache svg inlinesvg smil svgclippaths" lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Try Chef Infra - Modules | Learn Chef
    </title>
    <link href="https://learn.chef.io/favicon.ico" rel="icon" type="image/x-icon">
    <link rel="canonical" href="https://learn.chef.io/modules/try-chef-infra/">
    <!-- base href="https://learn.chef.io/modules/try-chef-infra" -->
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, user-scalable=no" name="viewport">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta content="https://learn.chef.io/modules/try-chef-infra/" property="og:url">
    <meta content="Curious how to start automating your infrastructure? Check out #learnchef Rally to get started. Chef Workstation sets you up with all you need to help you quickly enforce configuration policies across heterogeneous environments. https://learn.chef.io/modules/try-chef/" name="twitter:description">
    <meta content="https://learn.chef.io/assets/images/social/module-share-d5b17d4f.png" name="twitter:image">
    <meta content="See how Chef Infra can help you automate changes to your infrastructure." name="description">
    <link href="application-320ef737b3-b6bd3b29.css" rel="stylesheet">
  </head>
  <body class="modules modules_try-chef-infra modules_try-chef-infra_index unit-page">

<a aria-label="Close" class="close-reveal-modal"><i class="icon ic-close"></i></a></div></div><section id="main-content" style="margin-top: 105px;"><div class="content"><div class="hero module-hero"><div class="row"><div class="large-12 columns"><h1 class="head"> Try Chef Infra </h1><div class="description"> See how Chef Infra can help you automate changes to your infrastructure. </div></div></div></div><div class="row module-header"><div class="large-8 columns">

<a class="anchor" id="step1" name="step1"></a><h2>1. Install Docker and Docker Compose<span class="section-links"><a class="section-link" href="#step1"><i class="fa fa-paragraph"></i></a><a class="section-link" href="#top" name="#top"><i class="fa fa-long-arrow-up"></i></a></span></h2><p>The
 installation is a set of containers orchestrated with Docker Compose, a
 tool for defining and running multi-container Docker applications.</p><p>You'll need a Windows, macOS, or 64-bit Linux system.</p><p>If you're new to Docker, you can <a href="https://docs.docker.com/engine/docker-overview/" target="_blank">read this overview</a> to get a better understanding of how Docker works.</p><ul><li><strong>Install on Windows</strong><p>Install <a href="https://docs.docker.com/docker-for-windows/install/" target="_blank">Docker for Windows</a> or <a href="https://docs.docker.com/toolbox/toolbox_install_windows/" target="_blank">Docker Toolbox</a>.</p><p>Generally
 speaking, if your Windows system can run Hyper-V, you'll want to 
install Docker for Windows. If your system can't run Hyper-V, or you 
prefer to run your containers through VirtualBox, you'll want Docker 
Toolbox. <a href="https://docs.docker.com/docker-for-windows/install/#what-to-know-before-you-install" target="_blank">Learn more</a></p></li><li><strong>Install on macOS</strong></p><p>Install <a href="https://docs.docker.com/docker-for-mac/install/" target="_blank">Docker for Mac</a>.</p></li><li><strong>Install on Linux</strong></p><p>See the <a href="https://docs.docker.com/compose/install/" target="_blank">Docker Compose installation guide</a>.</p></li></ul>

<a class="anchor" id="step2" name="step2"></a><h2>2. Set up your environment<span class="section-links"><a class="section-link" href="#step2"><i class="fa fa-paragraph"></i></a><a class="section-link" href="#top" name="#top"><i class="fa fa-long-arrow-up"></i></a></span></h2><p>In this module, you'll use a set of Docker images that we've created for you.</p><p>The
 setup includes four systems – one that acts as your workstation and a 
three that act as the targets, or the system you want to configure.</p><p>The Docker images are based on Ubuntu 16.04. The workstation image comes with <a href="https://www.chef.sh/docs/chef-workstation/getting-started/" target="_blank">Chef Workstation</a></p><p>Chef
 Workstation gives you everything you need to get started with the Chef 
tools. Ad-hoc remote execution, scans and configuration tasks, cookbook 
creation tools, as well as robust dependency and testing software all in
 one easy-to-install package.</p><p>Start by creating a working directory. We recommend <code class="file-path">~/try-chef</code>.</p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: ~</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span></pre></td><td class="code"><pre><code><span class="line command">mkdir ~/try-chef-infra</span></code></pre></td></tr></tbody></table></div></div></div><p>Next, move to your working directory.</p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: ~</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span></pre></td><td class="code"><pre><code><span class="line command">cd ~/try-chef-infra</span></code></pre></td></tr></tbody></table></div></div></div><p>Next, get the Docker Compose file. Run the command that matches your system to download a file named <code class="file-path">docker-compose.yml</code>.</p><p><strong>Windows:</strong></p><div class="window Win32"><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Windows PowerShell: ~/try-chef-infra</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">PS &gt;</span></pre></td><td class="code"><pre><code><span class="line command">Invoke-WebRequest -useb -o docker-compose.yml https://raw.githubusercontent.com/learn-chef/chef/master/docker-compose.yml</span></code></pre></td></tr></tbody></table></div></div></div><p><strong>macOS:</strong></p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: ~/try-chef-infra</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span></pre></td><td class="code"><pre><code><span class="line command">curl -o docker-compose.yml https://raw.githubusercontent.com/learn-chef/chef/master/docker-compose.yml</span></code></pre></td></tr></tbody></table></div></div></div><p><strong>Linux:</strong></p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: ~/try-chef-infra</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span></pre></td><td class="code"><pre><code><span class="line command">wget https://raw.githubusercontent.com/learn-chef/chef/master/docker-compose.yml</span></code></pre></td></tr></tbody></table></div></div></div><p>Next, run the following <code>docker-compose</code> command to retrieve the latest workstation images. Docker must be running in order to use this command.</p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: ~/try-chef-infra</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line command">docker-compose pull</span><span class="line output">Pulling target (learnchef/chef_target:latest)...</span><span class="line output">latest: Pulling from learnchef/chef_target</span><span class="line output truncated-output">[...]</span><span class="line output">Pulling workstation (learnchef/chef_workstation:latest)...</span><span class="line output">latest: Pulling from learnchef/chef_workstation</span><span class="line output truncated-output">[...]</span></code></pre></td></tr></tbody></table></div></div></div><p>Next, run the following <code>docker-compose</code> command to start the containers. The <code>-d</code> argument starts the containers in the background.</p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: ~/try-chef-infra</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span></pre></td><td class="code"><pre><code><span class="line command">docker-compose up -d</span></code></pre></td></tr></tbody></table></div></div></div><p>If you get an error like this -- <code>Cannot
 create container for service workstation: Conflict. The container name 
"/workstation" is already in use by container 
"58bb327f4cbead2241399daaf9a6843e82...". You have to remove (or rename) 
that container to be able to reuse that name</code> -- it may due to a previous Docker setup that was not cleaned up.</p><p>You can resolve such an error by running this command: <code>docker system prune -a</code>. Then run <code>docker-compose pull</code> and <code>docker-compose up -d</code> again. You could also refer to this documentation for more details about <a href="https://www.digitalocean.com/community/tutorials/how-to-remove-docker-images-containers-and-volumes" target="_blank">removing Docker containers</a>.</p>

<p>Now
 that your containers are running in the background, run this command to
 start an interactive Bash session on the workstation container.</p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: ~/try-chef-infra</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line command">docker exec -it workstation bash</span><span class="line output">Agent pid 25</span><span class="line output">Identity added: .ssh/try-chef.key (.ssh/try-chef.key)</span></code></pre></td></tr></tbody></table></div></div></div>

<a class="anchor" id="step3" name="step3"></a><h2>3. Basic ingredients<span class="section-links" style="visibility: hidden;"><a class="section-link" href="#step3"><i class="fa fa-paragraph"></i></a><a class="section-link" href="#top" name="#top"><i class="fa fa-long-arrow-up"></i></a></span></h2><p>Chef
 Infra is driven by the concept of Resources, a single item that can be 
configured on your system. Normally you would collect these together in 
Chef recipes, but we are going to demonstrate them as simply as possible
 using the <code>chef-run</code> command to create a file on one of our target systems.</p><table class="info-table alert-box "><tbody><tr class="info-row"><td class="info-column-icon"><i class="fa fa-2x fa-info-circle comment-icon"></i></td><td class="info-column-content"><p>On this first invocation of the <code>chef-run</code> command you will be asked to accept the <a href="https://www.chef.io/end-user-license-agreement/" target="_blank">Chef EULA</a>
 Note thisis only accepting it inside the context of the docker 
container, so even if you have already accepted it on your own computer,
 you will have to accept it again.</p></td></tr></tbody></table><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: /root</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line command">chef-run web1 file hello.txt</span><span class="line output">[✔] Generated local policyfile</span><span class="line output">[✔] [web1] Connected.</span><span class="line output">[✔] [web1] Successfully installed Chef client version 14.3.37</span><span class="line output">[✔] [web1] Successfully converged target!</span></code></pre></td></tr></tbody></table></div></div></div><p>Let's break that down a little. First, the command is <code>chef-run</code>.
 This is a utility to run adhoc Chef Infra commands on a remote server. 
It provides a good way to get started with Chef Infra, without requiring
 any infrastructure beyond SSH.</p><p>Next is the host name of the machine we are going to be configuring--web1.</p><p>Finally we have file <code>hello.txt</code>. This refers to the Chef Infra <code>file</code> resource and passes it the name <code>hello.txt</code>. This has the effect of creating a file called <code>hello.txt</code> on the machine. We don't need to provide any credentials because we have provisioned these test machines with SSH keys.</p><p>We can see that <code>chef-run</code>
 connected to our target machine, ensured Chef Infra Client is 
installed, and then ran it with our resource. We are able to test what 
has happened by running a command over ssh. Note we have specified a 
path here of the root (<code>/</code>) directory. This is the default working directory for chef if you don't specify anything else.</p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: /root</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span><span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line command">ssh web1 cat /hello.txt</span><span class="line output">Warning: Permanently added 'web1,172.20.0.4' (ECDSA) to the list of known hosts.</span></code></pre></td></tr></tbody></table></div></div></div><p>Well,
 that wasn't very interesting, we didn't get any output. Although there 
weren't any errors, let's run a different command to ensure the file 
really is there.</p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: /root</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line command">ssh web1 ls -l /hello.txt</span><span class="line output">Warning: Permanently added 'web1,172.20.0.4' (ECDSA) to the list of known hosts.</span><span class="line output">-rw-r--r-- 1 root root 0 Oct 25 12:43 /hello.txt</span></code></pre></td></tr></tbody></table></div></div></div><p>Ah,
 definitely a file, so it clearly doesn't have any content. What has 
happened is we have asked Chef to create a file, but not actually 
specified anything else. Let's try again, but this time with some 
content.</p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: /root</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line command">chef-run web1 file hello.txt content='Hello World!'</span><span class="line output">[✔] Generated local policyfile</span><span class="line output">[✔] [web1] Connected.</span><span class="line output">[✔] [web1] Chef client version 14.3.37 already installed on target</span><span class="line output">[✔] [web1] Successfully converged target!</span></code></pre></td></tr></tbody></table></div></div></div><p>Here we have added to the <code>chef-run</code> command, by providing a <code>property</code> to the <code>file</code> resource. This property is <code>content</code>
 and specifies the content of the file. This is a primitive way to 
create a file, and we shall see more flexible ways later. Let's prove it
 has worked by looking at the file again.</p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: /root</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line command">ssh web1 cat /hello.txt</span><span class="line output">Warning: Permanently added 'web1,172.20.0.4' (ECDSA) to the list of known hosts.</span><span class="line output">Hello World!root@33543c57c361:~#</span></code></pre></td></tr></tbody></table></div></div></div><p>Note
 that we didn't add a new line, so our prompt is appended to the end of 
the file output, but we can see the file has been created with content.</p><p>We can also ask Chef Infra to remove the file by defining an action, overriding the default of <code>create</code>.</p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: /root</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line command">chef-run web1 file hello.txt action=delete</span><span class="line output">[✔] Generated local policyfile</span><span class="line output">[✔] [web1] Connected.</span><span class="line output">[✔] [web1] Chef client version 14.3.37 already installed on target.</span><span class="line output">[✔] [web1] Successfully converged target!</span></code></pre></td></tr></tbody></table></div></div></div><p>If we try and look at the file again we can see it has been removed:</p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: /root</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span><span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line command">ssh web1 cat /hello.txt</span><span class="line output">cat: /hello.txt: No such file or directory</span></code></pre></td></tr></tbody></table></div></div></div>

<a class="anchor" id="step4" name="step4"></a><h2>4. Recipes for success<span class="section-links"><a class="section-link" href="#step4"><i class="fa fa-paragraph"></i></a><a class="section-link" href="#top" name="#top"><i class="fa fa-long-arrow-up"></i></a></span></h2><p>If
 you want to configure more than a single item on your system, you will 
need to collect your resources together in a recipe. With a recipe, Chef
 Infra will process the resources in the order they appear.</p><p>We 
have included a basic recipe for you to try. It will install a utility, 
FIGlet, and use it to create a file with a hello world message. Let's 
take a look at the file and talk through it.</p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: /root</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line command">cat recipe.rb</span><span class="line output">apt_update</span><span class="line output">&nbsp;</span><span class="line output">package 'figlet'</span><span class="line output">&nbsp;</span><span class="line output">directory '/tmp'</span><span class="line output">&nbsp;</span><span class="line output">execute 'write_hello_world' do</span><span class="line output">    command 'figlet Hello World! &gt; /tmp/hello.txt'</span><span class="line output">    not_if { File.exist?('/tmp/hello.txt') }</span><span class="line output">end</span></code></pre></td></tr></tbody></table></div></div></div><p>There is a lot going on here, but we will work through it in stages.</p><p>The
 first line,&nbsp;apt_update, invokes a Chef Infra resource designed for
 Debian and Ubuntu systems which ensures that the package repository is 
up-to-date and that the packages we install will be the latest version. 
The documentation gives more details if you wish to understand further.</p><p>The next line, <code>package 'figlet'</code>,
 will install the package. We don't have to tell Chef how to install the
 package, we just said that we wanted it installed. This is part of the 
power of Chef: it allows us to work cross-platform. We simply state how 
we wish a system to look, and when Chef Infra converges, it uses the 
correct commands for the system it is running on to bring it into the 
state we desire.</p><p>Next, we ensure our temporary directory exists with <code>directory '/tmp'</code>.
 One of the great powers of Chef Infra is that we can safely include 
this line, even if this directory already exists. The Chef Infra Client 
will only take action if it needs to. This is known as <em>test &amp; repair</em>.
 By including it we ensure that the next lines will not fail if the 
directory does not exist, but not cause problems if it does.</p><p>The next four lines are more complex: they are all related to one resource, the <code>execute</code>
 resource. This time, however, we need to give it more information. 
Unlike the previous commands, the name does not get used by the resource
 to direct the action, so instead we just provide a descriptive name.</p><p>We finish the line off with the keyword <code>do</code>. This indicates to Chef Infra that we want to give more arguments to the resource.</p><p>The next two lines (indented above for clarity) are again <code>parameters</code>. This is how we give resources extra information like in the file example above.</p><ul><li>First we have <code>command</code>. This is the shell command that is to be executed by the resource. Here we are going to run <code>figlet</code> and direct the output to a file.</li><li>Next we have <code>not_if</code>. This parameter is known as a&nbsp;guard. We use guards to provide the test part of&nbsp;<em>test &amp; repair</em>
 for more generic resources. In this case, we test for the existence of 
the file we want to create, and if it exists, Chef Infra will not run 
the resource.</li></ul><p>This is not a perfect test, as it doesn't check that the contents of the file is correct, but will serve our purposes for now.</p><p>Finally the keyword <code>end</code> indicates we are finished giving the resource parameters.</p><p>Let's run it on our test machine again, and see the results.</p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: /root</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line command">chef-run web1 recipe.rb</span><span class="line output">[✔] [web1] Connected.</span><span class="line output">[✔] [web1] Chef client version 14.3.37 already installed on target</span><span class="line output">[✔] [web1] Successfully converged target!</span></code></pre></td></tr></tbody></table></div></div></div><p>This command is similar to the previous command, but instead of providing the resource and a parameter (<code>package cowsay</code>) we just provide the name of the recipe <code>recipe.rb</code></p><p>We can test what happened in a similar manner to the last time:</p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: /root</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line command">ssh web1 cat /tmp/hello.txt</span><span class="line output">Warning: Permanently added 'web1,172.21.0.2' (ECDSA) to the list of known hosts.</span><span class="line output"> _   _      _ _        __        __         _     _ _</span><span class="line output">| | | | ___| | | ___   \ \      / /__  _ __| | __| | |</span><span class="line output">| |_| |/ _ \ | |/ _ \   \ \ /\ / / _ \| '__| |/ _` | |</span><span class="line output">|  _  |  __/ | | (_) |   \ V  V / (_) | |  | | (_| |_|</span><span class="line output">|_| |_|\___|_|_|\___/     \_/\_/ \___/|_|  |_|\__,_(_)</span></code></pre></td></tr></tbody></table></div></div></div>

<a class="anchor" id="step5" name="step5"></a><h2>5. Cooking up Awesome<span class="section-links"><a class="section-link" href="#step5"><i class="fa fa-paragraph"></i></a><a class="section-link" href="#top" name="#top"><i class="fa fa-long-arrow-up"></i></a></span></h2><p>As
 we saw before, recipes are great for gathering together a selection of 
resources but there are still some limitations. One in particular is 
highlighted by the <code>file</code>. You can use the <code>file</code> resource to create a text file on disk, and use the <code>content</code> property to add the text, as follows</p><div class="window " ng-non-bindable=""><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Editor: Untitled</h1><div class="container"><div class="editor"><div class="highlight ruby"><pre class="code_wrapper"><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="n">file</span> <span class="s1">'/foo/bar'</span> <span class="k">do</span>
  <span class="n">content</span> <span class="s1">'Hello World!'</span>
  <span class="n">mode</span> <span class="s1">'0755'</span>
  <span class="n">owner</span> <span class="s1">'myuser'</span>
  <span class="n">group</span> <span class="s1">'mygroup'</span>
<span class="k">end</span></pre></td></tr></tbody></table></pre></div></div></div></div><p>This
 can quickly become complex and messy as we add more text over several 
lines, especially if that text contains special characters that would 
need to be escaped, like '\'.</p><p>Instead, we should be able to keep 
the content in separate files from the Chef Infra code. To do this, we 
need a way to package all the pieces of our recipe together. We call 
this package a cookbook.</p><p>We have included for you two cookbooks - 
one that will setup a webserver and one that will setup a load balancer.
 The load balancer will balance traffic to the two web server machines 
we have.</p><p>We are going to demonstrate an additional feature of <code>chef-run</code> that allows you to quickly apply a cookbook to more than one server simultaneously.</p><p>First however, we should take a look at our webserver cookbook.</p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: /root</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line command">tree webserver</span><span class="line output">webserver/</span><span class="line output">|-- README.md</span><span class="line output">|-- metadata.rb</span><span class="line output">|-- recipes</span><span class="line output">|   `-- default.rb</span><span class="line output">`-- templates</span><span class="line output">    `-- index.html.erb</span><span class="line output">&nbsp;</span><span class="line output">2 directories, 4 files</span></code></pre></td></tr></tbody></table></div></div></div><p>This represents a basic cookbook with just the minimal of files.</p><ul><li>The <code>README.md</code>
 file gives description of the cookbook and how it should be used. While
 not mandatory, it is highly recommended that all cookbooks include a 
README.</li><li>The <code>metadata.rb</code> file is required for all 
cookbooks. It contains the name and version number of the cookbook and 
information about dependencies. You can lean more about the metadata.rb <a href="https://docs.chef.io/config_rb_metadata.html" target="_blank">here</a>.</li></ul><p>Next we have two folders--<code>recipes</code> and <code>templates</code>.</p><ul><li><code>recipes</code> contain the recipes. You may have as many as necessary including the default recipe,<code>default.rb</code>, which is the recipe that is run if another is not specified.</li><li><code>templates</code>
 directory contains templates for text files that are required by a 
recipe, for example for configuration files that need populated with 
realtime data</li></ul><p>The recipes are similar to above, but you have a couple more resources available. If we look at the recipe we can see:</p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: /root</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line command">cat webserver/recipes/default.rb</span><span class="line output">&nbsp;</span><span class="line output">#</span><span class="line output"># Cookbook:: webserver</span><span class="line output"># Recipe:: default</span><span class="line output">#</span><span class="line output"># Copyright:: 2018, The Authors, All Rights Reserved.</span><span class="line output">apt_update</span><span class="line output">&nbsp;</span><span class="line output">package 'apache2'</span><span class="line output">&nbsp;</span><span class="line output">template '/var/www/html/index.html' do</span><span class="line output">  source 'index.html.erb'</span><span class="line output">end</span><span class="line output">&nbsp;</span><span class="line output">service 'apache2' do</span><span class="line output">  action [:enable, :start]</span><span class="line output">end</span></code></pre></td></tr></tbody></table></div></div></div><p>This is very similar to our previous recipe. The part to highlight is the <code>template</code> resource. As you can see we pass it a parameter of <code>source</code>. This refers to a template in the templates directory we saw above. Let's take a look at it.</p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: /root</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line command">cat webserver/templates/index.html.erb</span><span class="line output">&lt;html&gt;</span><span class="line output">  &lt;head&gt;</span><span class="line output">    &lt;title&gt;Learn Chef Demo&lt;/title&gt;</span><span class="line output">  &lt;/head&gt;</span><span class="line output">  &lt;body&gt;</span><span class="line output">    &lt;h1&gt;Hello Learn Chef&lt;/h1&gt;</span><span class="line output">    &lt;p&gt;This is &lt; % =node['hostname']% &gt;&lt;/p&gt;</span><span class="line output">  &lt;/body&gt;</span><span class="line output">&lt;/html&gt;</span></code></pre></td></tr></tbody></table></div></div></div><p>For the most part, this is just some HTML. However there is one part that is unusual <code>&lt; %=node['hostname']% &gt;</code>
 This is syntax in the templating language that will be replaced by the 
hostname of the machine. This is explained in more detail in the <a href="https://learn.chef.io/modules/learn-the-basics/ubuntu/aws/make-your-recipe-more-manageable#/step20">Make your recipe more manageable module</a>.</p><p>Let's run that on our test machines, this time using a slightly different <code>chef-run</code> syntax to apply it to two machines at once, web1 and web2:</p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: /root</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line command">chef-run web[1:2] webserver</span><span class="line output">┌ [✔] Converging targets:</span><span class="line output">├── ✔ [web1] Successfully converged target!</span><span class="line output">└── ✔ [web2] Successfully converged target!</span></code></pre></td></tr></tbody></table></div></div></div><p>We can test these by connecting to our new web servers:</p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: /root</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line command">curl web1</span><span class="line output">&lt;html&gt;</span><span class="line output">  &lt;head&gt;</span><span class="line output">    &lt;title&gt;Learn Chef Demo&lt;/title&gt;</span><span class="line output">  &lt;/head&gt;</span><span class="line output">  &lt;body&gt;</span><span class="line output">    &lt;h1&gt;Hello Learn Chef&lt;/h1&gt;</span><span class="line output">    &lt;p&gt;This is ae6574960e01&lt;/p&gt;</span><span class="line output">  &lt;/body&gt;</span><span class="line output">&lt;/html&gt;</span></code></pre></td></tr></tbody></table></div></div></div><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: /root</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line command">curl web2</span><span class="line output">&lt;html&gt;</span><span class="line output">  &lt;head&gt;</span><span class="line output">    &lt;title&gt;Learn Chef Demo&lt;/title&gt;</span><span class="line output">  &lt;/head&gt;</span><span class="line output">  &lt;body&gt;</span><span class="line output">    &lt;h1&gt;Hello Learn Chef&lt;/h1&gt;</span><span class="line output">    &lt;p&gt;This is f00120a691c4&lt;/p&gt;</span><span class="line output">  &lt;/body&gt;</span><span class="line output">&lt;/html&gt;</span></code></pre></td></tr></tbody></table></div></div></div><p>Here
 you can see the power of Chef Infra. Very quickly we have provisioned 
two webservers, each configured the same, including the required local 
changes.</p><p>To wrap up, we'll setup a load balancer in front of those
 web servers. You can look at the recipe and template in the same way as
 before.</p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: /root</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line command">cat loadbalancer/recipes/default.rb</span><span class="line output">#</span><span class="line output"># Cookbook:: loadbalancer</span><span class="line output"># Recipe:: default</span><span class="line output">#</span><span class="line output"># Copyright:: 2018, The Authors, All Rights Reserved.</span><span class="line output">apt_update</span><span class="line output">package 'haproxy'</span><span class="line output">&nbsp;</span><span class="line output">directory '/etc/haproxy'</span><span class="line output">&nbsp;</span><span class="line output">template '/etc/haproxy/haproxy.cfg' do</span><span class="line output">    source 'haproxy.cfg.erb'</span><span class="line output">end</span><span class="line output">&nbsp;</span><span class="line output">service 'haproxy' do</span><span class="line output">    action [:enable, :start]</span><span class="line output">end</span></code></pre></td></tr></tbody></table></div></div></div><table class="info-table alert-box tip"><tbody><tr class="info-row"><td class="info-column-icon"><i class="fa fa-2x fa-lightbulb-o tip-icon"></i></td><td class="info-column-content"><p>The <code>directory</code>
 resource isn't strictly necessary as the package will create it, but 
it's good practice to manage any directories that you place files into.</p></td></tr></tbody></table><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: /root</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line command">cat loadbalancer/templates/haproxy.cfg.erb</span><span class="line output">global</span><span class="line output">    log         127.0.0.1 local2</span><span class="line output">&nbsp;</span><span class="line output">    chroot      /var/lib/haproxy</span><span class="line output">    pidfile     /var/run/haproxy.pid</span><span class="line output">    maxconn     4000</span><span class="line output">    user        haproxy</span><span class="line output">    group       haproxy</span><span class="line output">    daemon</span><span class="line output">&nbsp;</span><span class="line output">    stats socket /var/lib/haproxy/stats</span><span class="line output">&nbsp;</span><span class="line output">defaults</span><span class="line output">    mode                    http</span><span class="line output">    log                     global</span><span class="line output">    option                  httplog</span><span class="line output">    option                  dontlognull</span><span class="line output">    option http-server-close</span><span class="line output">    option forwardfor       except 127.0.0.0/8</span><span class="line output">    option                  redispatch</span><span class="line output">    retries                 3</span><span class="line output">    timeout http-request    10s</span><span class="line output">    timeout queue           1m</span><span class="line output">    timeout connect         10s</span><span class="line output">    timeout client          1m</span><span class="line output">    timeout server          1m</span><span class="line output">    timeout http-keep-alive 10s</span><span class="line output">    timeout check           10s</span><span class="line output">    maxconn                 3000</span><span class="line output">&nbsp;</span><span class="line output">frontend  main</span><span class="line output">    bind                 *:80</span><span class="line output">    acl url_static       path_beg       -i /static /images /javascript /stylesheets</span><span class="line output">    acl url_static       path_end       -i .jpg .gif .png .css .js</span><span class="line output">&nbsp;</span><span class="line output">    use_backend static          if url_static</span><span class="line output">    default_backend             app</span><span class="line output">&nbsp;</span><span class="line output">backend static</span><span class="line output">    balance     roundrobin</span><span class="line output">    server      static 127.0.0.1:4331 check</span><span class="line output">&nbsp;</span><span class="line output">backend app</span><span class="line output">    balance     roundrobin</span><span class="line output">    server web1 web1:80 weight 1 maxconn 100 check</span><span class="line output">    server web2 web2:80 weight 1 maxconn 100 check</span></code></pre></td></tr></tbody></table></div></div></div><p>The recipe is almost identical but using the <code>haproxy</code> package and service in place of <code>apache2</code>.
 This is a common pattern of cookbooks, to install an application, 
create a config file, and then start the service, so you will see it a 
lot.</p><p>The haproxy configuration file looks daunting, but in this 
case it has nothing particular to Chef Infra in it, we have just hard 
coded the webservers to connect to at the bottom of the file.</p><table class="info-table alert-box "><tbody><tr class="info-row"><td class="info-column-icon"><i class="fa fa-2x fa-info-circle comment-icon"></i></td><td class="info-column-content"><p>Using
 Chef Infra server gives you the opportunity to create this 
configuration dynamically. You can learn more about Chef Infra Server <a href="https://docs.chef.io/server_components.html" target="_blank">here</a>.</p></td></tr></tbody></table><p>Let's apply this configuration and see it all working.</p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: /root</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line command">chef-run lb loadbalancer</span><span class="line output">[✔] [lb] Connected.</span><span class="line output">[✔] [lb] Successfully installed Chef client version 14.3.37</span><span class="line output">[✔] [lb] Successfully converged target!</span></code></pre></td></tr></tbody></table></div></div></div><p>As we did previously, we just have to provide the name of the server <code>lb</code> and the cookbook <code>loadbalancer</code>.</p><p>Congratulations, you have setup a three node system with Chef Infra!</p>

<div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: /root</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span><span class="line-number">&nbsp;</span></pre></td><td class="code"><pre><code><span class="line command">curl lb</span><span class="line output">&lt;html&gt;</span><span class="line output">  &lt;head&gt;</span><span class="line output">    &lt;title&gt;Learn Chef Demo&lt;/title&gt;</span><span class="line output">  &lt;/head&gt;</span><span class="line output">  &lt;body&gt;</span><span class="line output">    &lt;h1&gt;Hello Learn Chef&lt;/h1&gt;</span><span class="line output">    &lt;p&gt;This is ae6574960e01&lt;/p&gt;</span><span class="line output">  &lt;/body&gt;</span><span class="line output">&lt;/html&gt;</span></code></pre></td></tr></tbody></table></div></div></div>

<a class="anchor" id="cleanup" name="cleanup"></a><h2>Clean up<span class="section-links" style="visibility: hidden;"><a class="section-link" href="#cleanup"><i class="fa fa-paragraph"></i></a><a class="section-link" href="#top" name="#top"><i class="fa fa-long-arrow-up"></i></a></span></h2><p>You can experiment more with your setup. When you're done experimenting, run <code>exit</code> to leave your workstation container.</p><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: /root</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span></pre></td><td class="code"><pre><code><span class="line command">exit</span></code></pre></td></tr></tbody></table></div></div></div><p>You can run the following <code>docker-compose down</code> command to destroy your setup.</p><table class="info-table alert-box "><tbody><tr class="info-row"><td class="info-column-icon"><i class="fa fa-2x fa-info-circle comment-icon"></i></td><td class="info-column-content"><p>Keep in mind that this command will destroy your setup and delete the Docker images from disk. Omit the <code>--rmi all</code> argument to delete the containers but keep the images on disk.</p></td></tr></tbody></table><div class="window "><nav class="control-window"><div class="close">×</div><div class="minimize"></div><div class="deactivate"></div></nav><h1 class="titleInside">Terminal: ~/try-chef</h1><div class="container"><div class="terminal"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">$</span></pre></td><td class="code"><pre><code><span class="line command">docker-compose down --rmi all</span></code></pre></td></tr></tbody></table></div></div></div><p>To bring up a fresh installation, run the <code>docker-compose up -d</code> command as you did in <a href="#step2">step 2</a>.</p>

</body></html>
